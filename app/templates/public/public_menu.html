
{% include 'public_navbar.html' %}
<div class="container mx-auto px-2 md:px-8">
    <h2 class="font-bold text-2xl md:text-3xl mb-6 mt-2">Our Menu</h2>
    <form method="get" class="mb-6">
        <div class="flex flex-wrap gap-3 items-center">
            <label for="category" class="font-medium text-gray-700">Filter by Category:</label>
            <select name="category" id="category" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring focus:border-blue-400 text-sm" onchange="this.form.submit()">
                <option value="">All</option>
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if selected_category == category.id %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for dish in dishes %}
        {% set dish_cart = cart.get(dish.id|string, {'half': 0, 'full': 0}) %}
        <div class="bg-white rounded-xl shadow hover:shadow-lg transition h-full flex flex-col">
            <a href="{{ url_for('public.dish_detail', slug=restaurant.slug, dish_id=dish.id) }}" class="no-underline text-gray-900">
                {% if dish.image %}
                <img src="{{ url_for('static', filename='images/' ~ dish.image) }}" class="rounded-t-xl w-full object-cover mb-2" alt="{{ dish.name }}" style="height:180px;">
                {% endif %}
                <h5 class="font-bold text-lg mb-1 px-2">{{ dish.name }}</h5>
            </a>
            <div class="mb-2 px-2">
                <div class="flex flex-col gap-2">
                    {% if dish.price_half %}
                    <div class="flex items-center gap-2">
                        <label class="min-w-[40px] text-sm">Half:</label>
                        <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 rounded px-2 py-1 text-xs font-bold transition" onclick="updateQuantity({{ dish.id }}, 'half', 'decrease', this)">-</button>
                        <input type="number" value="{{ dish_cart.half }}" min="0" class="w-12 text-center border rounded px-1 py-1 text-sm" readonly id="half-qty-{{ dish.id }}">
                        <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 rounded px-2 py-1 text-xs font-bold transition" onclick="updateQuantity({{ dish.id }}, 'half', 'increase', this)">+</button>
                        <span class="bg-blue-600 text-white rounded px-2 py-1 text-xs ml-2">₹{{ dish.price_half }}</span>
                    </div>
                    {% endif %}
                    {% if dish.price_full %}
                    <div class="flex items-center gap-2">
                        <label class="min-w-[40px] text-sm">Full:</label>
                        <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 rounded px-2 py-1 text-xs font-bold transition" onclick="updateQuantity({{ dish.id }}, 'full', 'decrease', this)">-</button>
                        <input type="number" value="{{ dish_cart.full }}" min="0" class="w-12 text-center border rounded px-1 py-1 text-sm" readonly id="full-qty-{{ dish.id }}">
                        <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 rounded px-2 py-1 text-xs font-bold transition" onclick="updateQuantity({{ dish.id }}, 'full', 'increase', this)">+</button>
                        <span class="bg-green-600 text-white rounded px-2 py-1 text-xs ml-2">₹{{ dish.price_full }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="mt-auto flex justify-center px-2 pb-3">
                <a href="{{ url_for('public.dish_detail', slug=restaurant.slug, dish_id=dish.id) }}" class="border border-blue-600 text-blue-600 rounded-lg px-4 py-2 text-sm font-semibold hover:bg-blue-50 transition w-full text-center">View Details</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Floating Cart Icon -->
<a href="{{ url_for('public.view_cart', slug=restaurant.slug) }}" class="fixed bottom-8 right-8 z-50 bg-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center no-underline hover:bg-green-50 transition">
    <img src="https://cdn-icons-png.flaticon.com/512/263/263142.png" alt="Cart" class="w-8 h-8">
    <span class="absolute top-2 right-2 bg-red-500 text-white rounded-full px-2 py-0.5 text-xs font-bold min-w-[22px] text-center shadow" id="cart-count">{{ cart_count or 0 }}</span>
    <span class="sr-only">Cart</span>
</a>

<script>
function updateQuantity(dishId, portion, action, buttonElement) {
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Show loading state
    const originalBg = buttonElement.className;
    buttonElement.className = buttonElement.className.replace('bg-gray-200', 'bg-blue-200');
    buttonElement.disabled = true;
    
    fetch(`/{{ restaurant.slug }}/cart/update-quantity/${dishId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            portion: portion,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the quantity display
            document.getElementById(`${portion}-qty-${dishId}`).value = data[`item_${portion}`];
            
            // Update the cart count in the floating icon
            document.getElementById('cart-count').textContent = data.cart_count;
            
            // Show success feedback
            buttonElement.className = buttonElement.className.replace('bg-blue-200', 'bg-green-200');
            setTimeout(() => {
                buttonElement.className = originalBg;
                buttonElement.disabled = false;
            }, 300);
        } else {
            // Reset button on error
            buttonElement.className = originalBg;
            buttonElement.disabled = false;
            alert('Failed to update cart. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error updating cart:', error);
        buttonElement.className = originalBg;
        buttonElement.disabled = false;
        alert('Failed to update cart. Please try again.');
    });
}
</script>
